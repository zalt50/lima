# Example to use Singularity instead of containerd & nerdctl
# $ limactl start ./singularity-debian.yaml
# $ limactl shell singularity-debian singularity run -u -B $HOME:$HOME docker://alpine

# This example requires Lima v0.7.0 or later
images:
- location: "https://cloud.debian.org/images/cloud/bullseye/daily/20220226-930/debian-11-generic-amd64-daily-20220226-930.qcow2"
  arch: "x86_64"
  digest: "sha512:a500f466bc44360a945f597e326b30948e041b2f7d49f79f1ea32d61135aff4eb7171ff175cd4084c8d324e422e228fb64418cb3019864336fb911be3b539f80"
- location: "https://cloud.debian.org/images/cloud/bullseye/daily/20220226-930/debian-11-generic-arm64-daily-20220226-930.qcow2"
  arch: "aarch64"
  digest: "sha512:43dcd8f1c552e03cbd4ac713db80212bb756a218beca23f5ce227dfa678964093eb23a5b9b175cd72c0a8443eedd305a7047faeae6165091ffa5feb32eacc40f"
mounts:
- location: "~"
- location: "/tmp/lima"
  writable: true
containerd:
  system: false
  user: false
provision:
- mode: system
  script: |
    #!/bin/bash
    set -eux -o pipefail
    command -v singularity >/dev/null 2>&1 && exit 0
    export DEBIAN_FRONTEND=noninteractive
    apt-get install --no-install-recommends -y \
      build-essential \
      squashfs-tools \
      libseccomp-dev \
      pkg-config \
      cryptsetup \
      binfmt-support \
      qemu-user \
      qemu-user-static
    case `uname -m` in
      "x86_64")
        apt-get install --no-install-recommends -y \
          qemu-system-arm
        curl -fsSL "https://dl.google.com/go/go${GO_VERSION}.linux-amd64.tar.gz" | \
        tar xz -C /usr/local
        ;;
      "aarch64")
        apt-get install --no-install-recommends -y \
          qemu-system-x86
        curl -fsSL "https://dl.google.com/go/go${GO_VERSION}.linux-arm64.tar.gz" | \
        tar xz -C /usr/local
        ;;
    esac
    export PATH=/usr/local/go/bin:${PATH}
    export GOPATH=/tmp/go
    export GOCACHE=${GOPATH}/.cache
    SINGULARITY_SRC=/tmp/singularity
    mkdir -p ${SINGULARITY_SRC}
    curl -fsSL "https://github.com/sylabs/singularity/releases/download/v${SINGULARITY_VERSION}/singularity-ce-${SINGULARITY_VERSION}.tar.gz" | \
    tar xz -C ${SINGULARITY_SRC} --strip-components 1
    cd ${SINGULARITY_SRC}
    ./mconfig
    make -C ./builddir
    make -C ./builddir install
    sed -i -e "/bind path = \/etc\/hosts/a bind path = \/Users" /usr/local/etc/singularity/singularity.conf
    rm -rf ${GOPATH} ${SINGULARITY_SRC}
probes:
- script: |
    #!/bin/bash
    set -eux -o pipefail
    if ! timeout 30s bash -c "until command -v singularity >/dev/null 2>&1; do sleep 3; done"; then
      echo >&2 "singularity is not installed yet"
      exit 1
    fi
  hint: See "/var/log/cloud-init-output.log". in the guest
env:
  GO_VERSION: 1.17.8
  SINGULARITY_VERSION: 3.9.5
