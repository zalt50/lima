# Example to use Singularity instead of containerd & nerdctl
# $ limactl start ./apptainer-debian.yaml
# $ limactl shell apptainer-debian apptainer run -u -B $HOME:$HOME docker://alpine

# This example requires Lima v0.7.0 or later
images:
- location: "https://cloud.debian.org/images/cloud/bullseye/20221020-1174/debian-11-generic-amd64-20221020-1174.qcow2"
  arch: "x86_64"
  digest: "sha512:334bd66215a8ebf98009fc5d1198aa3c99ec1a71d0cd55befb9e5413d016f8b43eeaf141af7f5ae82b6c32a02ad68a0418e1be623df6f62ccf782c31e29af429"
- location: "https://cloud.debian.org/images/cloud/bullseye/20221020-1174/debian-11-generic-arm64-20221020-1174.qcow2"
  arch: "aarch64"
  digest: "sha512:bd1e3b95e589df3ec8f869a9e7d14bbd2f64f479e52c0e93c7c3e6576177a0796c17c5b4775086215163b5427c2a77bf7816ffad012aeab11bfdb813f11ed467"
mounts:
- location: "~"
- location: "/tmp/lima"
  writable: true
containerd:
  system: false
  user: false
provision:
- mode: system
  script: |
    #!/bin/bash
    set -eux -o pipefail
    command -v apptainer >/dev/null 2>&1 && exit 0
    export DEBIAN_FRONTEND=noninteractive
    apt-get install --no-install-recommends -y \
      build-essential \
      libseccomp-dev \
      pkg-config \
      squashfs-tools \
      cryptsetup \
      binfmt-support \
      qemu-user \
      qemu-user-static
    case `uname -m` in
      "x86_64")
        apt-get install --no-install-recommends -y \
          qemu-system-arm
        curl -fsSL "https://go.dev/dl/go${GO_VERSION}.linux-amd64.tar.gz" | \
        tar xz -C /usr/local
        ;;
      "aarch64")
        apt-get install --no-install-recommends -y \
          qemu-system-x86
        curl -fsSL "https://go.dev/dl/go${GO_VERSION}.linux-arm64.tar.gz" | \
        tar xz -C /usr/local
        ;;
    esac
    export PATH=/usr/local/go/bin:${PATH}
    export GOPATH=/tmp/go
    export GOCACHE=${GOPATH}/.cache
    APPTAINER_SRC=/tmp/apptainer
    mkdir -p ${APPTAINER_SRC}
    curl -fsSL "https://github.com/apptainer/apptainer/releases/download/v${APPTAINER_VERSION}/apptainer-${APPTAINER_VERSION}.tar.gz" | \
    tar xz -C ${APPTAINER_SRC} --strip-components 1
    cd ${APPTAINER_SRC}
    ./mconfig
    make -C ./builddir
    make -C ./builddir install
    sed -i -e "/bind path = \/etc\/hosts/a bind path = \/Users" /usr/local/etc/apptainer/apptainer.conf
    rm -rf ${GOPATH} ${APPTAINER_SRC}
probes:
- script: |
    #!/bin/bash
    set -eux -o pipefail
    if ! timeout 30s bash -c "until command -v apptainer >/dev/null 2>&1; do sleep 3; done"; then
      echo >&2 "apptainer is not installed yet"
      exit 1
    fi
  hint: See "/var/log/cloud-init-output.log". in the guest
env:
  GO_VERSION: 1.19.2
  APPTAINER_VERSION: 1.1.3
