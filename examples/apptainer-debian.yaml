# Example to use Singularity instead of containerd & nerdctl
# $ limactl start ./apptainer-debian.yaml
# $ limactl shell apptainer-debian apptainer run -u -B $HOME:$HOME docker://alpine

# This example requires Lima v0.7.0 or later
images:
- location: "https://cloud.debian.org/images/cloud/bullseye/20230124-1270/debian-11-generic-amd64-20230124-1270.qcow2"
  arch: "x86_64"
  digest: "sha512:fa152c6159dcb73adb1b573da3631937068c6a465ce7565a16dcce7aebd27c9a62ad783296d408300b99616cad89b8c0092e11df0fc2aa423334d741ac83b1a2"
- location: "https://cloud.debian.org/images/cloud/bullseye/20230124-1270/debian-11-generic-arm64-20230124-1270.qcow2"
  arch: "aarch64"
  digest: "sha512:d714ed2b70322bb2c4adc588f96671192a5ca67f70e20c3fb51c89d55b6a9646f00a6e6f0e5da241b7017916bb19b65a5703a1e3b3869a89c0da7047ac6c4e53"
mounts:
- location: "~"
- location: "/tmp/lima"
  writable: true
containerd:
  system: false
  user: false
provision:
- mode: system
  script: |
    #!/bin/bash
    set -eux -o pipefail
    command -v apptainer >/dev/null 2>&1 && exit 0
    export DEBIAN_FRONTEND=noninteractive
    apt-get install --no-install-recommends -y \
      build-essential \
      libseccomp-dev \
      pkg-config \
      squashfs-tools \
      cryptsetup \
      binfmt-support \
      qemu-user \
      qemu-user-static
    case `uname -m` in
      "x86_64")
        apt-get install --no-install-recommends -y \
          qemu-system-arm
        curl -fsSL "https://go.dev/dl/go${GO_VERSION}.linux-amd64.tar.gz" | \
        tar xz -C /usr/local
        ;;
      "aarch64")
        apt-get install --no-install-recommends -y \
          qemu-system-x86
        curl -fsSL "https://go.dev/dl/go${GO_VERSION}.linux-arm64.tar.gz" | \
        tar xz -C /usr/local
        ;;
    esac
    export PATH=/usr/local/go/bin:${PATH}
    export GOPATH=/tmp/go
    export GOCACHE=${GOPATH}/.cache
    APPTAINER_SRC=/tmp/apptainer
    mkdir -p ${APPTAINER_SRC}
    curl -fsSL "https://github.com/apptainer/apptainer/releases/download/v${APPTAINER_VERSION}/apptainer-${APPTAINER_VERSION}.tar.gz" | \
    tar xz -C ${APPTAINER_SRC} --strip-components 1
    cd ${APPTAINER_SRC}
    ./mconfig
    make -C ./builddir
    make -C ./builddir install
    sed -i -e "/bind path = \/etc\/hosts/a bind path = \/Users" /usr/local/etc/apptainer/apptainer.conf
    rm -rf ${GOPATH} ${APPTAINER_SRC}
probes:
- script: |
    #!/bin/bash
    set -eux -o pipefail
    if ! timeout 30s bash -c "until command -v apptainer >/dev/null 2>&1; do sleep 3; done"; then
      echo >&2 "apptainer is not installed yet"
      exit 1
    fi
  hint: See "/var/log/cloud-init-output.log". in the guest
env:
  GO_VERSION: 1.20.1
  APPTAINER_VERSION: 1.1.6
